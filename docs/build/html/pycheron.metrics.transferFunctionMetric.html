<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pycheron.metrics.transferFunctionMetric &#8212; Pycheron 2.1.0 documentation</title>
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html"><span><img src="_static/horse-128.png"></span>
          Pycheron</a>
        <span class="navbar-text navbar-version pull-left"><b>2.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="install.html">Install</a></li>
                <li><a href="pycheron.html">Documentation</a></li>
                <li><a href="https://gitlab.sandia.gov/lynm/pycheron">Gitlab</a></li>
                <li><a href="tutorials">Tutorials</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Documentation <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">pycheron.metrics.transferFunctionMetric</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="section" id="module-pycheron.metrics.transferFunctionMetric">
<span id="pycheron-metrics-transferfunctionmetric"></span><h1>pycheron.metrics.transferFunctionMetric<a class="headerlink" href="#module-pycheron.metrics.transferFunctionMetric" title="Permalink to this headline">¶</a></h1>
<dl class="function">
<dt id="pycheron.metrics.transferFunctionMetric.transferFunctionMetric">
<code class="descname">transferFunctionMetric</code><span class="sig-paren">(</span><em>tr1</em>, <em>tr2</em>, <em>logger=None</em>, <em>database=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/pycheron/metrics/transferFunctionMetric.html#transferFunctionMetric"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#pycheron.metrics.transferFunctionMetric.transferFunctionMetric" title="Permalink to this definition">¶</a></dt>
<dd><p>Calculates metrics that assess the relationship between two SNCLs with the same network, station and channel but
separate locations.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>tr1</strong> (<em>obspy.core.trace.Trace</em>) – (trace) obspy trace object 1</li>
<li><strong>tr2</strong> (<em>obspy.core.trace.Trace</em>) – (trace) obspy trace object 2</li>
<li><strong>logger</strong> (<a class="reference internal" href="pycheron.util.logger.html#pycheron.util.logger.Logger" title="pycheron.util.logger.Logger"><em>pycheron.util.logger.Logger</em></a>) – logger object</li>
<li><strong>database</strong> (<a class="reference internal" href="pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database" title="pycheron.db.sqllite_db.Database"><em>pycheron.db.sqllite_db.Database</em></a>) – database object</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><p>(dict) - dictionary with the following keys and values:</p>
<ul class="simple">
<li>snclq (<cite>str</cite>)</li>
<li>start_time (<cite>str</cite>)</li>
<li>end_time (<cite>str</cite>)</li>
<li>metric_name (<cite>str</cite>)</li>
<li>gain_ratio (<cite>float</cite>)</li>
<li>phase_diff (<cite>float</cite>)</li>
<li>ms_coherence (<cite>float</cite>)</li>
</ul>
</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">dict</p>
</td>
</tr>
</tbody>
</table>
<p>When seismometers are working properly, the transfer function amplitude and phase will match similar values
calculated from the instrument responses.</p>
<p>This function calculates the transfer function from data in the incoming streams (traces really). Response
information is then obtained from the evalresp web service <a class="footnote-reference" href="#id2" id="id1">[1]</a></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Seismic streams passed to transferFunctionMetric() must have the same network, station, and channel and must
cover the same time range. The two channels should also have values of azimuth and dip within 5 degrees of each
other. If sampling rates differ, and one is a multiple of the other, the stream with the higher sampling rate will
be decimated to match the lower sampling frequency. The output dictionary generated for these two-channel metrics
will have a SNCL code of the form: Net.Sta.Loc1:Loc2.Chan.</p>
</div>
<p><strong>Algorithm Steps</strong></p>
<ol class="arabic simple">
<li><dl class="first docutils">
<dt>Calculate complex transfer function:</dt>
<dd><ul class="first last">
<li>Request 1 hour of data (noise is ideal, so any consistent time is fine; only need this monthly or weekly)</li>
<li>If channel sample rates differ, decimate to make them identical</li>
<li>Detrend</li>
<li>Demean</li>
<li>Compute complex cross-spectrum of traces x and y –&gt; Pxx, Pxy, Pyy (same procedure as PSD)</li>
<li>Retrieve stored PSD Pxx(f)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Calculate transfer function values:</dt>
<dd><ul class="first last">
<li>Txy(f) = Pxy(f) / Pxx(f)</li>
<li>dataGain &lt;- Mod(Txy)</li>
<li>dataPhase &lt;- Arg(Txy)</li>
<li>Save avgDataGain (amplitude) and avgDataphase values for T=5-7s</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Calculate the corresponding response amplitude ratio and phase difference for x and y</dt>
<dd><ul class="first last">
<li>Request responses for x and y for that 1 hour</li>
<li>Calculate respGain = respGainy(f) / respGainx(f)</li>
<li>Calculate respPhase = respPhasey(f) - respPhasex(f)</li>
<li>Save avgRespGain and avgRespPhase values for T = 5-7s</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Calculate metrics:</dt>
<dd><ul class="first last">
<li>Calculate (data/resp) gain ratio for two saved gain averages:
gain_ratio = avgDataGain/avgRespGain (reasonableness of cross-spectral amplitudes between st1 and
st2)</li>
<li>Calculate (data-resp) phase difference from the two saved phase averages:
phase_diff = avgDataPhase - avgRespPhase (reasonableness of cross-spectral phases between st1 and
st2)</li>
<li>Calculate magnitude squared coherence of x and y:<ul>
<li>Retrieve stored PSD for Pxx and Pyy</li>
<li>ms_coherence = abs(Pxy)^2 / (Pxx*Pyy) (mean square coherence between st1 and st2)</li>
<li>Save the average MSCoherence for T=5-7s</li>
</ul>
</li>
</ul>
</dd>
</dl>
</li>
</ol>
<p>These values can be interpreted as follows:</p>
<ul class="simple">
<li>Whenever ms_coherence ~= 1.0, properly functioning seismometers should have:<ul>
<li>gain ratio ~= 1.0</li>
<li>phase_diff &lt; 10.0 (degrees)</li>
</ul>
</li>
</ul>
<p><strong>Example</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize IRIS client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="s2">&quot;IRIS&quot;</span><span class="p">)</span>

<span class="c1">#Define start/end times</span>
<span class="n">starttime</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="s2">&quot;2011-05-01T01:00:00.000&quot;</span><span class="p">)</span>
<span class="n">endtime</span> <span class="o">=</span> <span class="n">starttime</span> <span class="o">+</span> <span class="mi">3600</span>

<span class="c1"># Grab data from IRIS web client server with specified starttime/endtime and SNCL</span>
<span class="n">st1</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_waveforms</span><span class="p">(</span><span class="s2">&quot;CI&quot;</span><span class="p">,</span><span class="s2">&quot;PASC&quot;</span><span class="p">,</span><span class="s2">&quot;00&quot;</span><span class="p">,</span><span class="s2">&quot;BHZ&quot;</span><span class="p">,</span> <span class="n">starttime</span><span class="p">,</span><span class="n">endtime</span><span class="p">)</span>
<span class="n">st2</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_waveforms</span><span class="p">(</span><span class="s2">&quot;CI&quot;</span><span class="p">,</span><span class="s2">&quot;PASC&quot;</span><span class="p">,</span><span class="s2">&quot;10&quot;</span><span class="p">,</span><span class="s2">&quot;BHZ&quot;</span><span class="p">,</span> <span class="n">starttime</span><span class="p">,</span> <span class="n">endtime</span><span class="p">)</span>

<span class="c1"># Grab out traces</span>
<span class="n">tr1</span> <span class="o">=</span> <span class="n">st1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">tr2</span> <span class="o">=</span> <span class="n">st2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Calculate transfer function then print</span>
<span class="n">TF</span> <span class="o">=</span> <span class="n">transferFunctionMetric</span><span class="p">(</span><span class="n">tr1</span><span class="p">,</span><span class="n">tr2</span><span class="p">)</span>
<span class="k">print</span> <span class="n">TF</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">{</span><span class="s1">&#39;metric_name&#39;</span><span class="p">:</span> <span class="s1">&#39;transferFunction&#39;</span><span class="p">,</span> <span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="s2">&quot;2011-05-01T01:00:00.019500Z&quot;</span><span class="p">,</span> <span class="s1">&#39;snclq&#39;</span><span class="p">:</span> <span class="s1">&#39;PASC:CI:BHZ:00:BHZ:10&#39;</span><span class="p">,</span> <span class="s1">&#39;end_time&#39;</span><span class="p">:</span> <span class="s2">&quot;2011-05-01T01:59:59.994500Z&quot;</span><span class="p">,</span> <span class="s1">&#39;ms_coherence&#39;</span><span class="p">:</span> <span class="mf">0.9999875790954715</span><span class="p">,</span> <span class="s1">&#39;gain_ratio&#39;</span><span class="p">:</span> <span class="mf">0.9058981533571073</span><span class="p">,</span> <span class="s1">&#39;phase_diff&#39;</span><span class="p">:</span> <span class="mf">0.13553317118827302</span><span class="p">}</span>
</pre></div>
</div>
<p class="rubric">References</p>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://service.iris.edu/irisws/evalresp/1/">http://service.iris.edu/irisws/evalresp/1/</a></td></tr>
</tbody>
</table>
</dd></dl>

</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Jessica Bobeck, Katherine Anderson Aur.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.9.<br/>
    </p>
  </div>
</footer>
  </body>
</html>