<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pycheron.db.sqllite_db &#8212; Pycheron 2.1.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html"><span><img src="../../../_static/horse-128.png"></span>
          Pycheron</a>
        <span class="navbar-text navbar-version pull-left"><b>2.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../install.html">Install</a></li>
                <li><a href="../../../pycheron.html">Documentation</a></li>
                <li><a href="https://gitlab.sandia.gov/lynm/pycheron">Gitlab</a></li>
                <li><a href="tutorials">Tutorials</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Documentation <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for pycheron.db.sqllite_db</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">cStringIO</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">sqlite3</span> <span class="k">import</span> <span class="n">OperationalError</span><span class="p">,</span> <span class="n">DatabaseError</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">obspy.core</span> <span class="k">import</span> <span class="n">UTCDateTime</span>

<span class="kn">from</span> <span class="nn">pycheron.utils</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Database&quot;</span><span class="p">,</span> <span class="s2">&quot;UnicodeWriter&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="Database"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database">[docs]</a><span class="k">class</span> <span class="nc">Database</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a custom database class which interfaces with callPycheronMetric as well as the other metric functions in</span>
<span class="sd">    the library. The database creates (if not already created) an SQLlite3 database and connect to it.</span>

<span class="sd">    :param db_name: Name of database</span>
<span class="sd">    :type db_name: str</span>
<span class="sd">    :param session_name: Session name. Allows for multiple sessions for running the same data</span>
<span class="sd">    :type session_name: str</span>
<span class="sd">    :param overwrite: If `True` any data that is the same will be overwritten</span>
<span class="sd">    :type overwrite: bool</span>

<span class="sd">    To create a database:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        &gt;&gt;&gt; db = Database(&quot;test.db&quot;, session_name=&quot;session1&quot;, overwrite=True)</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">,</span> <span class="n">session_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">db_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span> <span class="o">=</span> <span class="n">session_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span> <span class="o">=</span> <span class="n">overwrite</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>

            <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="c1"># make main table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table pycheron (</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric VARCHAR,</span>
<span class="s2">                               latitude varchar,</span>
<span class="s2">                               longitude varchar</span>
<span class="s2">                               )&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make basicStatsMetric</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table basicStatsMetric (</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               snclq varchar,</span>
<span class="s2">                               number_of_samples varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               minimum varchar,</span>
<span class="s2">                               maximum varchar,</span>
<span class="s2">                               median varchar,</span>
<span class="s2">                               mean varchar,</span>
<span class="s2">                               variance varchar,</span>
<span class="s2">                               standard_deviation varchar,</span>
<span class="s2">                               rms varchar,</span>
<span class="s2">                               min_mask varchar,</span>
<span class="s2">                               max_mask varchar,</span>
<span class="s2">                               median_mask varchar,</span>
<span class="s2">                               mean_mask varchar,</span>
<span class="s2">                               variance_mask varchar,</span>
<span class="s2">                               std_mask varchar,</span>
<span class="s2">                               rms_mask varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel))&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make correlationMetric table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table correlationMetric (</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               snclq varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               correlation_coefficient varchar,</span>
<span class="s2">                               p_value varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel))&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make crossCorrMetric table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table crossCorrMetric (</span>
<span class="s2">                                created varchar primary key,</span>
<span class="s2">                                network varchar,</span>
<span class="s2">                                station varchar,</span>
<span class="s2">                                channel varchar,</span>
<span class="s2">                                location varchar,</span>
<span class="s2">                                session varchar,</span>
<span class="s2">                                snclq varchar,</span>
<span class="s2">                                start_time varchar,</span>
<span class="s2">                                end_time varchar,</span>
<span class="s2">                                metric_name varchar,</span>
<span class="s2">                                peak_correlation varchar,</span>
<span class="s2">                                peak_lag varchar,</span>
<span class="s2">                                FOREIGN KEY (metric_name) REFERENCES pycheron(metric))</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make DCOffSetMetricTimes table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table DCOffsetTimesMetric (</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               snclq varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               dc_offset_times varchar,</span>
<span class="s2">                               masks varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel))&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make dedChanADFMetric table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table deadChannel(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               snclq varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               dead_channel_times varchar,</span>
<span class="s2">                               masks varchar,</span>
<span class="s2">                               is_dead_channel varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel))&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make gapMetricSummary table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table gapMetricStation(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               station_completeness varchar,</span>
<span class="s2">                               total_gaps varchar,</span>
<span class="s2">                               total_overlaps varchar,</span>
<span class="s2">                               gap_masks varchar,</span>
<span class="s2">                               overlap_masks varchar,</span>
<span class="s2">                               combined_masks varchar,</span>
<span class="s2">                               maximum_overlap varchar,</span>
<span class="s2">                               maximum_gap varchar,</span>
<span class="s2">                               channel_percent_available varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station))&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make gapMetricChannel table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table gapMetricChannel(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               duration varchar,</span>
<span class="s2">                               gap_overlap_start_time varchar,</span>
<span class="s2">                               gap_overlap_end_time varchar,</span>
<span class="s2">                               type varchar,</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES gapMetricStation(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES gapMetricStation(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES gapMetricStation(channel))&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make psdMetric table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table psdMetric(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               snclq varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               noise2_mask varchar,</span>
<span class="s2">                               dead_channel_exponent varchar,</span>
<span class="s2">                               percent_above_nhnm varchar,</span>
<span class="s2">                               dead_channel_linear varchar,</span>
<span class="s2">                               uncorrected_psds varchar,</span>
<span class="s2">                               percent_below_nlnm varchar,</span>
<span class="s2">                               noise1_mask varchar,</span>
<span class="s2">                               bad_resp_mask varchar,</span>
<span class="s2">                               pdfs varchar,</span>
<span class="s2">                               hi_amp_mask varchar,</span>
<span class="s2">                               dc_mask varchar,</span>
<span class="s2">                               low_amp_mask varchar,</span>
<span class="s2">                               corrected_psds varchar,</span>
<span class="s2">                               dead_channel_gsn varchar,</span>
<span class="s2">                               dead_channel_exponent_hourly varchar,</span>
<span class="s2">                               dead_channel_linear_hourly varchar,</span>
<span class="s2">                               dead_channel_gsn_hourly varchar,</span>
<span class="s2">                               dead_chan_exp_hourly_masks varchar,</span>
<span class="s2">                               dead_chan_lin_hourly_masks varchar,</span>
<span class="s2">                               dead_chan_gsn_hourly_masks varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel))&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make repeatedAmplitudeMetric table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table repeatedAmplitudeMetric(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               snclq varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               count varchar,</span>
<span class="s2">                               mask varchar,</span>
<span class="s2">                               rep_amp varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel))&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make snrMetric table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table snrMetric(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               snclq varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               snr varchar,</span>
<span class="s2">                               algorithm varchar,</span>
<span class="s2">                               masks varchar,</span>
<span class="s2">                               windowSecs varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel))&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make sohMetricActivityFlags table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; create table sohMetricActivityFlags (</span>
<span class="s2">                           created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               calibration_signal varchar,</span>
<span class="s2">                               event_begin varchar,</span>
<span class="s2">                               event_end varchar,</span>
<span class="s2">                               event_in_progress varchar,</span>
<span class="s2">                               negative_leap varchar,</span>
<span class="s2">                               positive_leap varchar,</span>
<span class="s2">                               time_correction_applied varchar,                    </span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station))</span>

<span class="s2">               &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make sohMetricIOClockFlags table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; create table sohMetricIOClockFlags (</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               clock_locked varchar,</span>
<span class="s2">                               end_time_series varchar,</span>
<span class="s2">                               long_record_read varchar,</span>
<span class="s2">                               short_record_read varchar,</span>
<span class="s2">                               start_time_series varchar,</span>
<span class="s2">                               station_volume varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station))</span>

<span class="s2">               &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># make sohMetricDataQualityFlags table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table sohMetricDataQualityFlags (</span>
<span class="s2">                           created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               amplifier_saturation varchar,</span>
<span class="s2">                               digital_filter_charging varchar,</span>
<span class="s2">                               digitizer_clipping varchar,</span>
<span class="s2">                               glitches varchar,</span>
<span class="s2">                               missing_padded_data varchar,</span>
<span class="s2">                               spikes varchar,</span>
<span class="s2">                               suspect_time_tag varchar,</span>
<span class="s2">                               telemetry_sync_error varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station))</span>

<span class="s2">               &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make spikesMetric table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table spikesMetric(</span>
<span class="s2">               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               snclq varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               non_adjacent_spikes varchar,</span>
<span class="s2">                               mask varchar,</span>
<span class="s2">                               spike_times varchar, </span>
<span class="s2">                               total_spike_count varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel))</span>

<span class="s2">               &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make staltaMetric table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table staltaMetric(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               snclq varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               event_time varchar,</span>
<span class="s2">                               max_stalta varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel))</span>

<span class="s2">               &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make transferFucntionMetric table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table transferFunctionMetric(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               snclq varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               gain_ratio varchar,</span>
<span class="s2">                               phase_diff varchar,</span>
<span class="s2">                               ms_coherence varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel))</span>

<span class="s2">               &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make dailyPDFPlot table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table dailyPdfPlot(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               snclq varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               noise_masks varchar,</span>
<span class="s2">                               microseism_masks varchar,</span>
<span class="s2">                               banded_masks varchar,</span>
<span class="s2">                               pdf_grid_image_path varchar,</span>
<span class="s2">                               pdf_line_image_path varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel))</span>

<span class="s2">               &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make networkNoiseModel table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table networkNoiseModel(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               enModel varchar,</span>
<span class="s2">                               zModel varchar,</span>
<span class="s2">                               stations_en varchar,</span>
<span class="s2">                               stations_z varchar,</span>
<span class="s2">                               psdStats varchar,</span>
<span class="s2">                               network_noise_image_path varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network))                 </span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make stationNoiseModel table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table stationNoiseModel(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               type varchar,</span>
<span class="s2">                               station_noise_image_path varchar,</span>
<span class="s2">                               e_station_noiseModel varchar,</span>
<span class="s2">                               n_station_noiseModel varchar,</span>
<span class="s2">                               z_station_noiseModel varchar,</span>
<span class="s2">                               e_station_noiseModel_low varchar,</span>
<span class="s2">                               n_station_noiseModel_low varchar,</span>
<span class="s2">                               z_station_noiseModel_low varchar, </span>
<span class="s2">                               e_station_noiseModel_high varchar,</span>
<span class="s2">                               n_station_noiseModel_high varchar,</span>
<span class="s2">                               z_station_noiseModel_high varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station))</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make psdPlot table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table psdPlot(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               plot_style varchar,</span>
<span class="s2">                               type varchar,</span>
<span class="s2">                               timespan varchar,</span>
<span class="s2">                               image_path varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel))&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make calibrationMetric table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table calibrationMetric(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               start_time varchar,</span>
<span class="s2">                               end_time varchar,</span>
<span class="s2">                               snclq varchar,</span>
<span class="s2">                               detections varchar,</span>
<span class="s2">                               num_cals_detected varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel))&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make stationRankingPlot table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table stationRankingPlot(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               rank_by varchar,</span>
<span class="s2">                               image_path varchar,</span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel)</span>
<span class="s2">            )&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># make psdStatistics table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;create table psdStatistics(</span>
<span class="s2">                               created VARCHAR PRIMARY KEY,</span>
<span class="s2">                               network varchar,</span>
<span class="s2">                               station varchar,</span>
<span class="s2">                               location varchar,</span>
<span class="s2">                               channel varchar,</span>
<span class="s2">                               session varchar,</span>
<span class="s2">                               metric_name varchar,</span>
<span class="s2">                               noise_matrix_frequency varchar,</span>
<span class="s2">                               noise_matrix_noise varchar,</span>
<span class="s2">                               pdf_matrix varchar,</span>
<span class="s2">                               pdf_bins varchar,</span>
<span class="s2">                               max varchar,</span>
<span class="s2">                               min varchar,</span>
<span class="s2">                               mean varchar,</span>
<span class="s2">                               median varchar,</span>
<span class="s2">                               mode varchar,</span>
<span class="s2">                               nlnm varchar,</span>
<span class="s2">                               nhnm varchar,</span>
<span class="s2">                               percent_above_nhnm varchar,</span>
<span class="s2">                               percent_below_nlnm varchar,</span>
<span class="s2">                               percent_95 varchar,</span>
<span class="s2">                               percent_90 varchar,</span>
<span class="s2">                               percent_10 varchar,</span>
<span class="s2">                               percent_5 varchar, </span>
<span class="s2">                               FOREIGN KEY (metric_name) REFERENCES pycheron(metric),</span>
<span class="s2">                               FOREIGN KEY (network) REFERENCES pycheron(network),</span>
<span class="s2">                               FOREIGN KEY (station) REFERENCES pycheron(station),</span>
<span class="s2">                               FOREIGN KEY (channel) REFERENCES pycheron(channel)</span>
<span class="s2">            )&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">OperationalError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="c1"># if the database already exists, connect</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">{name}</span><span class="s2"> already exists. Connecting to </span><span class="si">{name}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>

<div class="viewcode-block" id="Database.set_overwrite"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.set_overwrite">[docs]</a>    <span class="k">def</span> <span class="nf">set_overwrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the overwrite parameters for database</span>

<span class="sd">        :param overwrite: If True, entries with the same session name, SNCLQ, and time will be over written.</span>
<span class="sd">        :type overwrite: bool</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span> <span class="o">=</span> <span class="n">overwrite</span></div>

<div class="viewcode-block" id="Database.set_session_name"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.set_session_name">[docs]</a>    <span class="k">def</span> <span class="nf">set_session_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the session name. Purpose of this is to separate different runs with the same data</span>

<span class="sd">        :param session_name: session name</span>
<span class="sd">        :type session_name: str</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span> <span class="o">=</span> <span class="n">session_name</span></div>

<div class="viewcode-block" id="Database.get_connection"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.get_connection">[docs]</a>    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the database connection.</span>

<span class="sd">        :return: database connection</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span></div>

<div class="viewcode-block" id="Database.connect"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connects to a specific database.</span>

<span class="sd">        :param db_name: database name</span>
<span class="sd">        :type db_name: str</span>

<span class="sd">        :return: database connection</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">db_name</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conn</span></div>

<div class="viewcode-block" id="Database.networks"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.networks">[docs]</a>    <span class="k">def</span> <span class="nf">networks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lists all of the unique networks in the database.</span>

<span class="sd">        :return: network names</span>
<span class="sd">        :rtype: list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select (</span><span class="si">{cn}</span><span class="s2">) from </span><span class="si">{tn}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tn</span><span class="o">=</span><span class="s2">&quot;pycheron&quot;</span><span class="p">,</span> <span class="n">cn</span><span class="o">=</span><span class="s2">&quot;network&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())))</span></div>

<div class="viewcode-block" id="Database.stations"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.stations">[docs]</a>    <span class="k">def</span> <span class="nf">stations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lists all of the unique stations in the database.</span>

<span class="sd">        :return: station names</span>
<span class="sd">        :rtype: list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select (</span><span class="si">{cn}</span><span class="s2">) from </span><span class="si">{tn}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tn</span><span class="o">=</span><span class="s2">&quot;pycheron&quot;</span><span class="p">,</span> <span class="n">cn</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())))</span></div>

<div class="viewcode-block" id="Database.channels"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.channels">[docs]</a>    <span class="k">def</span> <span class="nf">channels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lists all of the unique channels in the database.</span>

<span class="sd">        :return: channel names</span>
<span class="sd">        :rtype: list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select (</span><span class="si">{cn}</span><span class="s2">) from </span><span class="si">{tn}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tn</span><span class="o">=</span><span class="s2">&quot;pycheron&quot;</span><span class="p">,</span> <span class="n">cn</span><span class="o">=</span><span class="s2">&quot;channel&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())))</span></div>

<div class="viewcode-block" id="Database.metrics"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.metrics">[docs]</a>    <span class="k">def</span> <span class="nf">metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lists all of the unique metrics in the database.</span>

<span class="sd">        :return: metric names</span>
<span class="sd">        :rtype: list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select (</span><span class="si">{cn}</span><span class="s2">) from </span><span class="si">{tn}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tn</span><span class="o">=</span><span class="s2">&quot;pycheron&quot;</span><span class="p">,</span> <span class="n">cn</span><span class="o">=</span><span class="s2">&quot;metric&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())))</span></div>

<div class="viewcode-block" id="Database.session"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.session">[docs]</a>    <span class="k">def</span> <span class="nf">session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lists all of the sessions in the database</span>

<span class="sd">        :return: session names</span>
<span class="sd">        :rtype: list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select (</span><span class="si">{cn}</span><span class="s2">) from </span><span class="si">{tn}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tn</span><span class="o">=</span><span class="s2">&quot;pycheron&quot;</span><span class="p">,</span> <span class="n">cn</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())))</span></div>

<div class="viewcode-block" id="Database.view"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.view">[docs]</a>    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;View in the main directory table (pycheron) all of the databases contents. Sort by combinations of metric name, network, station, channel, locations, time, and session name. If no options are given, it will return everything in the pycheron table.</span>

<span class="sd">        :param metric_name: metric name</span>
<span class="sd">        :type metric_name: str</span>
<span class="sd">        :param network: network name</span>
<span class="sd">        :type network: str</span>
<span class="sd">        :param station: station name</span>
<span class="sd">        :type station: str</span>
<span class="sd">        :param channel: channel name</span>
<span class="sd">        :type channel: str</span>
<span class="sd">        :param location: location</span>
<span class="sd">        :type location: str</span>
<span class="sd">        :param time: Tuple of starttime and endtime strings. ex. `time = (&quot;2011-01-01T00:00:00&quot;,&quot;2011-01-01T23:55:13.190000&quot;)`</span>
<span class="sd">        :type time: tuple</span>
<span class="sd">        :param session: session name</span>
<span class="sd">        :type session: str</span>

<span class="sd">        :return: Pandas DataFrame</span>
<span class="sd">        :rtype: `pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if no location, change to --, otherwise it will be unsearchable/filterable</span>
        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

        <span class="c1"># dictionary of parameters</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric_name</span><span class="p">,</span>
            <span class="s2">&quot;network&quot;</span><span class="p">:</span> <span class="n">network</span><span class="p">,</span>
            <span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">station</span><span class="p">,</span>
            <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">location</span><span class="p">,</span>
            <span class="s2">&quot;channel&quot;</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
            <span class="s2">&quot;session&quot;</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span>
            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time</span>
        <span class="p">}</span>
        <span class="c1"># gets everything from pycheron table</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select </span><span class="si">{cn}</span><span class="s2"> from </span><span class="si">{tn}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tn</span><span class="o">=</span><span class="s2">&quot;pycheron&quot;</span><span class="p">,</span> <span class="n">cn</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="p">)</span>
        <span class="c1"># if gets error, try again</span>
        <span class="k">except</span> <span class="n">DatabaseError</span><span class="p">:</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select </span><span class="si">{cn}</span><span class="s2"> from </span><span class="si">{tn}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tn</span><span class="o">=</span><span class="s2">&quot;pycheron&quot;</span><span class="p">,</span> <span class="n">cn</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="p">)</span>

        <span class="c1"># loop through parameters dictionary</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="c1"># if there is no value, skip. If the key is time, skip</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span>
                <span class="c1"># grabs the location in the database table where it matches the input param</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tb</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">]</span>
            <span class="c1"># if the key is time, and not none</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span>
                <span class="c1"># split the tuple into start and end time</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">et</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># edge case for crossCorrMetric, still todo</span>
                <span class="k">if</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;crossCorrMetric&quot;</span><span class="p">:</span>
                    <span class="k">pass</span>
                    <span class="c1"># tb = tb.loc[tb[&quot;start_time&quot;] &gt;= str(UTCDateTime(st))]  # todo</span>
                    <span class="c1"># tb = tb.loc[tb[&quot;end_time&quot;] &lt;= str(UTCDateTime(et))]  # todo</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tb</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">st</span><span class="p">]</span>
                    <span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tb</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">et</span><span class="p">]</span>
        <span class="c1"># if no results are returned.</span>
        <span class="k">if</span> <span class="n">tb</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;No results found&quot;</span>
            <span class="k">return</span> <span class="n">tb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tb</span></div>

<div class="viewcode-block" id="Database.get_metric"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.get_metric">[docs]</a>    <span class="k">def</span> <span class="nf">get_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets data for specific metric. Searchable by network, station, channel, location, time and session name</span>

<span class="sd">        :param metric_name: metric name</span>
<span class="sd">        :type metric_name: str</span>
<span class="sd">        :param network: network name</span>
<span class="sd">        :type network: str</span>
<span class="sd">        :param station: station name</span>
<span class="sd">        :type station: str</span>
<span class="sd">        :param channel: channel name</span>
<span class="sd">        :type channel: str</span>
<span class="sd">        :param location: location</span>
<span class="sd">        :type location: str</span>
<span class="sd">        :param time: Tuple of starttime and endtime. ex. `time = (&quot;2011-01-01T00:00:00&quot;,&quot;2011-01-01T23:55:13.190000&quot;)`</span>
<span class="sd">        :type time: tuple</span>
<span class="sd">        :param session: session name</span>
<span class="sd">        :type session: str</span>

<span class="sd">        :return: Pandas DataFrame</span>
<span class="sd">        :rtype: `pandas.DataFrame`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># connects to database</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># if there is no location, set to --, otherwise it is unsearchable. networkNoiseModel does not have a location</span>
        <span class="c1"># so skip</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">location</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">metric_name</span> <span class="o">!=</span> <span class="s1">&#39;networkNoiseModel&#39;</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

        <span class="c1"># param dictionary</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;network&quot;</span><span class="p">:</span> <span class="n">network</span><span class="p">,</span>
            <span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">station</span><span class="p">,</span>
            <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">location</span><span class="p">,</span>
            <span class="s2">&quot;channel&quot;</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
            <span class="s2">&quot;session&quot;</span><span class="p">:</span> <span class="n">session</span>
        <span class="p">}</span>
        <span class="c1"># gets everything from specific metric table</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select </span><span class="si">{cn}</span><span class="s2"> from </span><span class="si">{tn}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tn</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">cn</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="p">)</span>

        <span class="c1"># loops thru input params</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="c1"># if value is not set, or key is time, skip</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span>
                <span class="c1"># matching input param to database values</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tb</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">]</span>
            <span class="c1"># if key is time, split into start and end time, then filter.</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">et</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tb</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">st</span><span class="p">]</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tb</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">et</span><span class="p">]</span>

        <span class="c1"># if no results are returned</span>
        <span class="k">if</span> <span class="n">tb</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;No results found&quot;</span>
            <span class="k">return</span> <span class="n">tb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tb</span></div>

<div class="viewcode-block" id="Database.query"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For advanced users, a direct SQL command or statement can be used.</span>

<span class="sd">        :param sql: SQL formated statement</span>
<span class="sd">        :type sql: str</span>

<span class="sd">        :return: Pandas DataFrame</span>
<span class="sd">        :rtype: `pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tb</span></div>

<div class="viewcode-block" id="Database.insert_metric"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.insert_metric">[docs]</a>    <span class="k">def</span> <span class="nf">insert_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inserts metric into database</span>

<span class="sd">        :param metric: metric results</span>
<span class="sd">        :type metric: data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get connection</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span>
        <span class="c1"># connect to database</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># get session name</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span>

        <span class="c1"># try/except sequence that deals with metrics whose names are inside lists or lists of lists</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>

        <span class="c1"># deals with metrics that have two SNCLQs</span>
        <span class="k">if</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;correlationMetric&quot;</span> <span class="ow">or</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;crossCorrMetric&quot;</span> <span class="ow">or</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;transferFunctionMetric&quot;</span><span class="p">:</span>
            <span class="c1"># getting snclqs for the data</span>
            <span class="n">snclq_combined</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq&quot;</span><span class="p">]</span>
            <span class="c1"># parses snclq which are formatted: SNCLQ_1:SNCLQ_2</span>
            <span class="n">snclq1</span><span class="p">,</span> <span class="n">snclq2</span> <span class="o">=</span> <span class="n">parse_snclq</span><span class="p">(</span><span class="n">snclq_combined</span><span class="p">,</span> <span class="n">comb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># parses SNCLQs into individual parts.</span>
            <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">parse_snclq</span><span class="p">(</span><span class="n">snclq1</span><span class="p">)</span>
            <span class="n">network2</span><span class="p">,</span> <span class="n">station2</span><span class="p">,</span> <span class="n">channel2</span><span class="p">,</span> <span class="n">location2</span><span class="p">,</span> <span class="n">quality2</span> <span class="o">=</span> <span class="n">parse_snclq</span><span class="p">(</span><span class="n">snclq2</span><span class="p">)</span>

            <span class="c1"># if location is not, change to -- otherwise it is unsortable</span>
            <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">location2</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>
                <span class="n">location2</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

            <span class="c1"># Create the timestamp for the metric. This will be used as the primary key.</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

            <span class="c1"># getting the starttime and endtimes for the metric</span>
            <span class="k">if</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;crossCorrMetric&quot;</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq1_starttime&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq2_starttime&quot;</span><span class="p">]</span>
                <span class="n">et</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq1_endtime&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq2_endtime&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span>
                <span class="n">et</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span>

            <span class="c1"># formatting the params to be inserted.</span>
            <span class="n">net</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{n}</span><span class="s1">:</span><span class="si">{n2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="n">network2</span><span class="p">)</span>
            <span class="n">sta</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{s}</span><span class="s1">:</span><span class="si">{s2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">s2</span><span class="o">=</span><span class="n">station2</span><span class="p">)</span>
            <span class="n">chan</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{c}</span><span class="s1">:</span><span class="si">{c2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">c2</span><span class="o">=</span><span class="n">channel2</span><span class="p">)</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{l}</span><span class="s1">:</span><span class="si">{l2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="n">location2</span><span class="p">)</span>

            <span class="c1"># checks current db to see if metric is already in db</span>
            <span class="n">current_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="n">net</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="n">sta</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">chan</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span>
                                   <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">))</span>

            <span class="c1"># if it is not currently in db</span>
            <span class="k">if</span> <span class="n">current_db</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;INSERT INTO pycheron( network, station, channel, location, session, metric, created, start_time, end_time )</span>
<span class="s2">                 VALUES (&#39;</span><span class="si">{n}</span><span class="s2">&#39;,&#39;</span><span class="si">{s}</span><span class="s2">&#39;, &#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39;, &#39;</span><span class="si">{metric}</span><span class="s2">&#39;, &#39;</span><span class="si">{created}</span><span class="s2">&#39;, &#39;</span><span class="si">{st}</span><span class="s2">&#39;, &#39;</span><span class="si">{et}</span><span class="s2">&#39;)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">n</span><span class="o">=</span><span class="n">net</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sta</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">chan</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span>
                    <span class="n">sn</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                    <span class="n">created</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="o">=</span><span class="n">et</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

            <span class="c1"># if it is in the database, check the overwrite param, if true, overwrite.</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span><span class="p">:</span>
                <span class="n">new_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">]</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">old_created</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">cn</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cn</span><span class="p">)):</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE pycheron SET </span><span class="si">{cn}</span><span class="s2"> = &#39;</span><span class="si">{new}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">cn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                                  <span class="n">new</span><span class="o">=</span><span class="n">new_vals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                                  <span class="n">c</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Entry already exists, turn on overwrite or change session name&quot;</span>

        <span class="c1"># deals with gapMetric</span>
        <span class="k">elif</span> <span class="s2">&quot;gapMetric&quot;</span> <span class="ow">in</span> <span class="n">metric_name</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">metricStation</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="n">network</span> <span class="o">=</span> <span class="n">metricStation</span><span class="p">[</span><span class="s2">&quot;network&quot;</span><span class="p">]</span>
                <span class="n">station</span> <span class="o">=</span> <span class="n">metricStation</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span>
                <span class="n">location</span> <span class="o">=</span> <span class="n">metricStation</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">metricStation</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="n">et</span> <span class="o">=</span> <span class="n">metricStation</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metricStation</span><span class="p">[</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

                <span class="n">current_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">))</span>

                <span class="c1"># if not currently in db</span>
                <span class="k">if</span> <span class="n">current_db</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;INSERT INTO pycheron( network, station, channel, location, session, metric, created,</span>
<span class="s2">                     start_time, end_time ) VALUES (&#39;</span><span class="si">{n}</span><span class="s2">&#39;,&#39;</span><span class="si">{s}</span><span class="s2">&#39;, &#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39;, &#39;</span><span class="si">{metric}</span><span class="s2">&#39;, &#39;</span><span class="si">{created}</span><span class="s2">&#39;, &#39;</span><span class="si">{st}</span><span class="s2">&#39;, &#39;</span><span class="si">{et}</span><span class="s2">&#39;)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                        <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="o">=</span><span class="n">et</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metricStation</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span><span class="p">:</span>
                    <span class="n">new_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">]</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">old_created</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">cn</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cn</span><span class="p">)):</span>
                        <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE pycheron SET </span><span class="si">{cn}</span><span class="s2"> = &#39;</span><span class="si">{new}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">cn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                                      <span class="n">new</span><span class="o">=</span><span class="n">new_vals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                                      <span class="n">c</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metricStation</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Entry already exists, turn on overwrite or change session name&quot;</span>

                <span class="c1"># if there are no gaps, there will be no additional data</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])):</span>
                        <span class="n">metricChannel</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>

                        <span class="n">snclq</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;network&quot;</span><span class="p">:</span> <span class="n">network</span><span class="p">,</span>
                                 <span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">station</span><span class="p">,</span>
                                 <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">location</span><span class="p">}</span>

                        <span class="n">metricChannel</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">snclq</span><span class="p">)</span>

                        <span class="n">timestamp_chan</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                        <span class="n">channel</span> <span class="o">=</span> <span class="n">metricChannel</span><span class="p">[</span><span class="s2">&quot;channel&quot;</span><span class="p">]</span>
                        <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metricChannel</span><span class="p">[</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                        <span class="n">current_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
                                               <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">))</span>

                        <span class="c1"># if not currently in db</span>
                        <span class="k">if</span> <span class="n">current_db</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                            <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;INSERT INTO pycheron( network, station, channel, location, session, metric, created,</span>
<span class="s2">                             start_time, end_time ) VALUES (&#39;</span><span class="si">{n}</span><span class="s2">&#39;,&#39;</span><span class="si">{s}</span><span class="s2">&#39;, &#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39;, &#39;</span><span class="si">{metric}</span><span class="s2">&#39;, &#39;</span><span class="si">{created}</span><span class="s2">&#39;, &#39;</span><span class="si">{st}</span><span class="s2">&#39;, &#39;</span><span class="si">{et}</span><span class="s2">&#39;)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="n">timestamp_chan</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                                <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="o">=</span><span class="n">et</span><span class="p">)</span>
                            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metricChannel</span><span class="p">,</span> <span class="n">timestamp_chan</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span><span class="p">:</span>
                            <span class="n">new_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">timestamp_chan</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span>
                                        <span class="n">metric_name</span><span class="p">]</span>
                            <span class="n">idx</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">old_created</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
                            <span class="n">cn</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cn</span><span class="p">)):</span>
                                <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE pycheron SET </span><span class="si">{cn}</span><span class="s2"> = &#39;</span><span class="si">{new}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">cn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                                              <span class="n">new</span><span class="o">=</span>
                                                                                                              <span class="n">new_vals</span><span class="p">[</span>
                                                                                                                  <span class="n">i</span><span class="p">],</span>
                                                                                                              <span class="n">c</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>
                                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metricChannel</span><span class="p">,</span> <span class="n">timestamp_chan</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="s2">&quot;Entry already exists, turn on overwrite or change session name&quot;</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="c1"># deals with sohMetric</span>
        <span class="k">elif</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;sohMetric&quot;</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="n">network</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;network&quot;</span><span class="p">]</span>
            <span class="n">station</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span>
            <span class="n">et</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

            <span class="c1"># check current db</span>
            <span class="n">current_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                                   <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">))</span>

            <span class="c1"># if not currently in db</span>
            <span class="k">if</span> <span class="n">current_db</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;INSERT INTO pycheron( network, station, channel, location, session ,metric, created, start_time, end_time)</span>
<span class="s2">                 VALUES (&#39;</span><span class="si">{n}</span><span class="s2">&#39;,&#39;</span><span class="si">{s}</span><span class="s2">&#39;, &#39;</span><span class="si">{chan}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39;,&#39;</span><span class="si">{metric}</span><span class="s2">&#39;, &#39;</span><span class="si">{created}</span><span class="s2">&#39;,  &#39;</span><span class="si">{st}</span><span class="s2">&#39;, &#39;</span><span class="si">{et}</span><span class="s2">&#39;)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">chan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                    <span class="n">created</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">st</span><span class="p">,</span>
                    <span class="n">et</span><span class="o">=</span><span class="n">et</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span><span class="p">:</span>
                <span class="n">new_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">]</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">old_created</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">cn</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">current_db</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                <span class="c1"># reverse so created is changed last, since primary key</span>
                <span class="n">cn</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="n">new_vals</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cn</span><span class="p">)):</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE pycheron SET </span><span class="si">{cn}</span><span class="s2"> = &#39;</span><span class="si">{new}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">cn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                                  <span class="n">new</span><span class="o">=</span><span class="n">new_vals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                                  <span class="n">c</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Entry already exists, turn on overwrite or change session name&quot;</span>

        <span class="c1"># deals with noiseModels (network and station)</span>
        <span class="k">elif</span> <span class="s2">&quot;NoiseModel&quot;</span> <span class="ow">in</span> <span class="n">metric_name</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="n">network</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;network&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;station&quot;</span> <span class="ow">in</span> <span class="n">metric_name</span><span class="p">:</span>  <span class="c1"># stationNoiseModel</span>
                <span class="n">station</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span>
                <span class="n">location</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

                <span class="n">current_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                                       <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>

                <span class="c1"># if not currently in db</span>
                <span class="k">if</span> <span class="n">current_db</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;INSERT INTO pycheron( network, station, location, session ,metric, created) VALUES (&#39;</span><span class="si">{n}</span><span class="s2">&#39;,&#39;</span><span class="si">{s}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39;,</span>
<span class="s2">                         &#39;</span><span class="si">{metric}</span><span class="s2">&#39;, &#39;</span><span class="si">{created}</span><span class="s2">&#39;)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                        <span class="n">created</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>

                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span><span class="p">:</span>
                    <span class="n">new_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;created&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s1">&#39;network&#39;</span><span class="p">:</span> <span class="n">network</span><span class="p">,</span> <span class="s1">&#39;station&#39;</span><span class="p">:</span> <span class="n">station</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">location</span><span class="p">,</span>
                                <span class="s1">&#39;session&#39;</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span> <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric_name</span><span class="p">}</span>

                    <span class="n">idx</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">old_created</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">cn</span> <span class="o">=</span> <span class="n">new_vals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cn</span><span class="p">)):</span>
                        <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE pycheron SET </span><span class="si">{cn}</span><span class="s2"> = &#39;</span><span class="si">{new}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">cn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                                                                                      <span class="n">new</span><span class="o">=</span>
                                                                                                      <span class="n">new_vals</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span>
                                                                                                          <span class="n">j</span><span class="p">],</span>
                                                                                                      <span class="n">c</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Entry already exists, turn on overwrite or change session name&quot;</span>

                <span class="c1"># commit changes</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># networkNoiseModel</span>
                <span class="n">current_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
                                       <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">)</span>

                <span class="c1"># if not currently in db</span>
                <span class="k">if</span> <span class="n">current_db</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>

                    <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;INSERT INTO pycheron( network, session , metric, created) VALUES (&#39;</span><span class="si">{n}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39;,</span>
<span class="s2">                         &#39;</span><span class="si">{metric}</span><span class="s2">&#39;, &#39;</span><span class="si">{created}</span><span class="s2">&#39;)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                        <span class="n">created</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>

                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span><span class="p">:</span>

                    <span class="n">new_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;created&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s1">&#39;network&#39;</span><span class="p">:</span> <span class="n">network</span><span class="p">,</span>
                                <span class="s1">&#39;session&#39;</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span> <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric_name</span><span class="p">}</span>

                    <span class="n">idx</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">old_created</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">cn</span> <span class="o">=</span> <span class="n">new_vals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cn</span><span class="p">)):</span>
                        <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE pycheron SET </span><span class="si">{cn}</span><span class="s2"> = &#39;</span><span class="si">{new}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">cn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                                                                                      <span class="n">new</span><span class="o">=</span>
                                                                                                      <span class="n">new_vals</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span>
                                                                                                          <span class="n">j</span><span class="p">],</span>
                                                                                                      <span class="n">c</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>

                        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Entry already exists, turn on overwrite or change session name&quot;</span>

                <span class="c1"># commit changes</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># deals with psd plot</span>
        <span class="k">elif</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;psdPlot&quot;</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)):</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>
                <span class="n">network</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;network&quot;</span><span class="p">]</span>
                <span class="n">station</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;station&quot;</span><span class="p">]</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;channel&quot;</span><span class="p">]</span>
                <span class="n">location</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

                <span class="c1"># check current db</span>
                <span class="n">current_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
                                       <span class="n">location</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>

                <span class="c1"># if not currently in db</span>
                <span class="k">if</span> <span class="n">current_db</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;INSERT INTO pycheron( network, station, channel, location, session ,metric, created) VALUES (&#39;</span><span class="si">{n}</span><span class="s2">&#39;,&#39;</span><span class="si">{s}</span><span class="s2">&#39;,&#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39;,</span>
<span class="s2">                         &#39;</span><span class="si">{metric}</span><span class="s2">&#39;, &#39;</span><span class="si">{created}</span><span class="s2">&#39;)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                        <span class="n">created</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>

                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">timestamp</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span><span class="p">:</span>
                    <span class="n">new_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;created&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s1">&#39;network&#39;</span><span class="p">:</span> <span class="n">network</span><span class="p">,</span> <span class="s1">&#39;station&#39;</span><span class="p">:</span> <span class="n">station</span><span class="p">,</span> <span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
                                <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">location</span><span class="p">,</span>
                                <span class="s1">&#39;session&#39;</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span> <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric_name</span><span class="p">}</span>

                    <span class="n">idx</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">old_created</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">cn</span> <span class="o">=</span> <span class="n">new_vals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cn</span><span class="p">)):</span>
                        <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE pycheron SET </span><span class="si">{cn}</span><span class="s2"> = &#39;</span><span class="si">{new}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">cn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                                                                                      <span class="n">new</span><span class="o">=</span>
                                                                                                      <span class="n">new_vals</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span>
                                                                                                          <span class="n">j</span><span class="p">],</span>
                                                                                                      <span class="n">c</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Entry already exists, turn on overwrite or change session name&quot;</span>

        <span class="c1"># deals with everything else</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">)):</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>
                <span class="n">snclq</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;snclq&quot;</span><span class="p">]</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span>
                <span class="n">et</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span>

                <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">parse_snclq</span><span class="p">(</span><span class="n">snclq</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

                <span class="c1"># check current db</span>
                <span class="n">current_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
                                       <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                                       <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">))</span>

                <span class="c1"># if not currently in db</span>
                <span class="k">if</span> <span class="n">current_db</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;INSERT INTO pycheron( network, station, channel, location, session ,metric, created, start_time, end_time) VALUES (&#39;</span><span class="si">{n}</span><span class="s2">&#39;,&#39;</span><span class="si">{s}</span><span class="s2">&#39;,&#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39;,</span>
<span class="s2">                     &#39;</span><span class="si">{metric}</span><span class="s2">&#39;, &#39;</span><span class="si">{created}</span><span class="s2">&#39;, &#39;</span><span class="si">{st}</span><span class="s2">&#39;, &#39;</span><span class="si">{et}</span><span class="s2">&#39;)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric_name</span><span class="p">,</span>
                        <span class="n">created</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="o">=</span><span class="n">et</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">timestamp</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span><span class="p">:</span>
                    <span class="n">new_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">]</span>

                    <span class="n">idx</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">old_created</span> <span class="o">=</span> <span class="n">current_db</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">cn</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">current_db</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                    <span class="c1"># reverse so created is changed last, since primary key</span>
                    <span class="n">cn</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="n">new_vals</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cn</span><span class="p">)):</span>
                        <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE pycheron SET </span><span class="si">{cn}</span><span class="s2"> = &#39;</span><span class="si">{new}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">cn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                                                                                      <span class="n">new</span><span class="o">=</span><span class="n">new_vals</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                                                                                      <span class="n">c</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric_wrapper</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">old_created</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;Entry already exists, turn on overwrite or change session name&quot;</span>

        <span class="c1"># commit changes to database</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Database.to_csv"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.to_csv">[docs]</a>    <span class="k">def</span> <span class="nf">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts all tables into CSV files. 1 file per table</span>

<span class="sd">        :param out_dir: directory location to save files</span>
<span class="sd">        :type out_dir: str</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dump_database_to_spreadsheets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="Database.to_dataframe"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.to_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts specific database table into pandas df</span>

<span class="sd">        :param table: table name</span>
<span class="sd">        :type table: str</span>

<span class="sd">        :return: Pandas DataFrame</span>
<span class="sd">        :rtype: `pandas.DataFrame`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></div>

<div class="viewcode-block" id="Database.extract_masks"><a class="viewcode-back" href="../../../pycheron.db.sqllite_db.html#pycheron.db.sqllite_db.Database.extract_masks">[docs]</a>    <span class="k">def</span> <span class="nf">extract_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extracts masks. Most masks are dumped into JSON format, this extracxts them and returns them to lists or dicts</span>

<span class="sd">        :param mask: mask from database</span>

<span class="sd">        :return: extracted mask</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">mask</span>

        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mask</span></div>

    <span class="k">def</span> <span class="nf">_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal function to extract nested list</span>
<span class="sd">        :param list: list</span>
<span class="sd">        :return: extracted list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">new_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">new_list</span>

    <span class="k">def</span> <span class="nf">_insert_metric_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal function wrapper that calls the correct metric inser function</span>

<span class="sd">        :param conn: database connection</span>
<span class="sd">        :param metric: metric data</span>
<span class="sd">        :param timestamp: created timestamp to be used as Primary Key</span>
<span class="sd">        :param overwrite: whether to overwrite or not.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;correlationMetric&quot;</span> <span class="ow">or</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;crossCorrMetric&quot;</span> <span class="ow">or</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;transferFunctionMetric&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_2_snclq_metric</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;gapMetric&quot;</span> <span class="ow">in</span> <span class="n">metric_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_gapMetric</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;sohMetric&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_sohMetric</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;NoiseModel&quot;</span> <span class="ow">in</span> <span class="n">metric_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_noiseModel</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;psdPlot&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_psdPlots</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_insert_metric</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>
        <span class="c1"># commit changes</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_insert_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inserts metric into database for non-special case metrics</span>

<span class="sd">        :param conn: database connection</span>
<span class="sd">        :param metric: metric data</span>
<span class="sd">        :param timestamp: timestamp to be used as primary key</span>
<span class="sd">        :param overwrite: overwrite term</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq&quot;</span><span class="p">]</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mn</span> <span class="o">==</span> <span class="s2">&quot;deadChanMeanMetric&quot;</span> <span class="ow">or</span> <span class="n">mn</span> <span class="o">==</span> <span class="s2">&quot;deadChannelMetric&quot;</span> <span class="ow">or</span> <span class="n">mn</span> <span class="o">==</span> <span class="s2">&quot;deadChanADFMetric&quot;</span><span class="p">:</span>
            <span class="n">mn</span> <span class="o">=</span> <span class="s2">&quot;deadChannel&quot;</span>

        <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">parse_snclq</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;insert into </span><span class="si">{mn}</span><span class="s2"> ( created, network, station, channel, location, session ) values ( &#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{n}</span><span class="s2">&#39;,</span>
<span class="s2">             &#39;</span><span class="si">{s}</span><span class="s2">&#39;, &#39;</span><span class="si">{chan}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39; )&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">chan</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
                                                        <span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;masks&quot;</span> <span class="ow">or</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;rep_amp&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;spike_times&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;dead_channel_times&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;dc_offset_times&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;detections&quot;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;uncorrected_psds&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)):</span>
                        <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>

                    <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                                                                              <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                              <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

        <span class="c1"># overwrite entry</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="c1"># update metric values</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;masks&quot;</span> <span class="ow">or</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;rep_amp&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;spike_times&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;dead_channel_times&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;dc_offset_times&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;detections&quot;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;uncorrected_psds&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)):</span>
                        <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>

                    <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                              <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="c1"># update session, not found in results dict</span>
            <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET session = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span>
                                                                                          <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="c1"># update created, must be last</span>
            <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET created = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                                                                                          <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_insert_2_snclq_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal function which inserts metrics with 2 snclqs (crossCorr, corrMetric, transferFunction)</span>

<span class="sd">        :param conn: database conncetion</span>
<span class="sd">        :param metric: metric data</span>
<span class="sd">        :param timestamp: timestamp to be used as primary key</span>
<span class="sd">        :param overwrite: overwrite term</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq&quot;</span><span class="p">]</span>

        <span class="n">snclq1</span><span class="p">,</span> <span class="n">snclq2</span> <span class="o">=</span> <span class="n">parse_snclq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">comb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">parse_snclq</span><span class="p">(</span><span class="n">snclq1</span><span class="p">)</span>
        <span class="n">network2</span><span class="p">,</span> <span class="n">station2</span><span class="p">,</span> <span class="n">channel2</span><span class="p">,</span> <span class="n">location2</span><span class="p">,</span> <span class="n">quality2</span> <span class="o">=</span> <span class="n">parse_snclq</span><span class="p">(</span><span class="n">snclq2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">location2</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>
            <span class="n">location2</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{n}</span><span class="s1">:</span><span class="si">{n2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="n">network2</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{s}</span><span class="s1">:</span><span class="si">{s2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">s2</span><span class="o">=</span><span class="n">station2</span><span class="p">)</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{c}</span><span class="s1">:</span><span class="si">{c2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">c2</span><span class="o">=</span><span class="n">channel2</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{l}</span><span class="s1">:</span><span class="si">{l2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="n">location2</span><span class="p">)</span>

        <span class="n">mn</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;insert into </span><span class="si">{mn}</span><span class="s2"> ( created, network, station, channel, location, session ) values ( &#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{n}</span><span class="s2">&#39;,</span>
<span class="s2">             &#39;</span><span class="si">{s}</span><span class="s2">&#39;, &#39;</span><span class="si">{chan}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39; )&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">chan</span><span class="o">=</span><span class="n">ch</span><span class="p">,</span>
                                                        <span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;masks&quot;</span> <span class="ow">or</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">mn</span> <span class="o">==</span> <span class="s2">&quot;crossCorrMetric&quot;</span> <span class="ow">and</span> <span class="s2">&quot;starttime&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;start_time&quot;</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq1_starttime&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq2_starttime&quot;</span><span class="p">]</span>

                <span class="k">elif</span> <span class="n">mn</span> <span class="o">==</span> <span class="s2">&quot;crossCorrMetric&quot;</span> <span class="ow">and</span> <span class="s2">&quot;endtime&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;end_time&quot;</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq1_endtime&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq2_endtime&quot;</span><span class="p">]</span>

                <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                              <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                              <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

        <span class="c1"># overwrite entry</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="c1"># update metric values</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;masks&quot;</span> <span class="ow">or</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">mn</span> <span class="o">==</span> <span class="s2">&quot;crossCorrMetric&quot;</span> <span class="ow">and</span> <span class="s2">&quot;starttime&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;start_time&quot;</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq1_starttime&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq2_starttime&quot;</span><span class="p">]</span>

                <span class="k">elif</span> <span class="n">mn</span> <span class="o">==</span> <span class="s2">&quot;crossCorrMetric&quot;</span> <span class="ow">and</span> <span class="s2">&quot;endtime&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;end_time&quot;</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq1_endtime&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;snclq2_endtime&quot;</span><span class="p">]</span>

                <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                              <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="c1"># update session, not found in results dict</span>
            <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET session = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span>
                                                                                          <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="c1"># update created, must be last</span>
            <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET created = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                                                                                          <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_insert_gapMetric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal function which inserts gapMetric into database</span>

<span class="sd">        :param conn: database conncetion</span>
<span class="sd">        :param metric: gap metric data</span>
<span class="sd">        :param timestamp: timestamp to be used as primary key</span>
<span class="sd">        :param overwrite: overwrite term</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">network</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;network&quot;</span><span class="p">]</span>
        <span class="n">station</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mn</span> <span class="o">==</span> <span class="s2">&quot;gapMetric&quot;</span><span class="p">:</span>
            <span class="n">mn</span> <span class="o">=</span> <span class="s1">&#39;gapMetricStation&#39;</span>

        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">==</span> <span class="n">unicode</span><span class="p">:</span>
            <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>
            <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;insert into </span><span class="si">{mn}</span><span class="s2"> ( created, network, station, location, session ) values ( &#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{n}</span><span class="s2">&#39;,</span>
<span class="s2">                     &#39;</span><span class="si">{s}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39; )&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">station</span><span class="p">,</span>
                                                      <span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">)</span>

            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;masks&quot;</span> <span class="ow">or</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                              <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                              <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>

                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

        <span class="c1"># overwrite entry</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="c1"># update metric values</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;masks&quot;</span> <span class="ow">or</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                              <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                              <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="c1"># update session, not found in results dict</span>
            <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET session = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                          <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span>
                                                                                          <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="c1"># update created, must be last</span>
            <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET created = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                                                                                          <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_insert_sohMetric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal function which inserts sohMetric into database</span>

<span class="sd">        :param conn: database conncetion</span>
<span class="sd">        :param metric: soh metric data</span>
<span class="sd">        :param timestamp: timestamp to be used as primary key</span>
<span class="sd">        :param overwrite: overwrite term</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="n">network</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;network&quot;</span><span class="p">]</span>
        <span class="n">station</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span>
        <span class="n">et</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;data_quality_flags&quot;</span><span class="p">:</span>
                <span class="n">mn</span> <span class="o">=</span> <span class="s2">&quot;sohMetricDataQualityFlags&quot;</span>

                <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;insert into </span><span class="si">{mn}</span><span class="s2"> ( created, network, station, location, session, start_time, end_time ) values ( &#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{n}</span><span class="s2">&#39;,</span>
<span class="s2">                     &#39;</span><span class="si">{s}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39;, &#39;</span><span class="si">{st}</span><span class="s2">&#39;, &#39;</span><span class="si">{et}</span><span class="s2">&#39; )&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">station</span><span class="p">,</span>
                                                                      <span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="o">=</span><span class="n">et</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                                      <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                                      <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="c1"># update metric values</span>

                        <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                                      <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                                      <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

                    <span class="c1"># update session, not found in results dict</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET session = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                                  <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span>
                                                                                                  <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

                    <span class="c1"># update created, must be last</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET created = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                                                                                                  <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;activity_flags&quot;</span><span class="p">:</span>

                <span class="n">mn</span> <span class="o">=</span> <span class="s2">&quot;sohMetricActivityFlags&quot;</span>

                <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;insert into </span><span class="si">{mn}</span><span class="s2"> ( created, network, station, location, session, start_time, end_time ) values ( &#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{n}</span><span class="s2">&#39;,</span>
<span class="s2">                     &#39;</span><span class="si">{s}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39;, &#39;</span><span class="si">{st}</span><span class="s2">&#39;, &#39;</span><span class="si">{et}</span><span class="s2">&#39; )&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">station</span><span class="p">,</span>
                                                                      <span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">st</span><span class="p">,</span>
                                                                      <span class="n">et</span><span class="o">=</span><span class="n">et</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                                      <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                                      <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                                      <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="c1"># update metric values</span>

                        <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                                      <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                                      <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                                      <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

                    <span class="c1"># update session, not found in results dict</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET session = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                                  <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span>
                                                                                                  <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

                    <span class="c1"># update created, must be last</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET created = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                                  <span class="n">val</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                                                                                                  <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;io_clock_flags&quot;</span><span class="p">:</span>

                <span class="n">mn</span> <span class="o">=</span> <span class="s2">&quot;sohMetricIOClockFlags&quot;</span>

                <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;insert into </span><span class="si">{mn}</span><span class="s2"> ( created, network, station, location, session, start_time, end_time ) values ( &#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{n}</span><span class="s2">&#39;,</span>
<span class="s2">                     &#39;</span><span class="si">{s}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39;, &#39;</span><span class="si">{st}</span><span class="s2">&#39;, &#39;</span><span class="si">{et}</span><span class="s2">&#39; )&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">station</span><span class="p">,</span>
                                                                      <span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">st</span><span class="p">,</span>
                                                                      <span class="n">et</span><span class="o">=</span><span class="n">et</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                                      <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                                      <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                                      <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="c1"># update metric values</span>

                        <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                                      <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                                      <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                                      <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

                    <span class="c1"># update session, not found in results dict</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET session = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                                  <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span>
                                                                                                  <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

                    <span class="c1"># update created, must be last</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET created = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                                  <span class="n">val</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                                                                                                  <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_insert_noiseModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal function which inserts networkNoiseModel or stationNoiseMNodel into database</span>

<span class="sd">        :param conn: database conncetion</span>
<span class="sd">        :param metric: metric data</span>
<span class="sd">        :param timestamp: timestamp to be used as primary key</span>
<span class="sd">        :param overwrite: overwrite term</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">mn</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>
        <span class="n">network</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;network&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mn</span> <span class="o">==</span> <span class="s2">&quot;networkNoiseModel&quot;</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;insert into </span><span class="si">{mn}</span><span class="s2"> ( created, network, session ) values ( &#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{n}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39; )&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                                                  <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                                                                                                                  <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
                                                                                                                  <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># stationNoiseModel</span>
                <span class="n">station</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span>
                <span class="n">location</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;insert into </span><span class="si">{mn}</span><span class="s2"> ( created, network, station, location, session ) values ( &#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{n}</span><span class="s2">&#39;,&#39;</span><span class="si">{sta}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;,&#39;</span><span class="si">{sn}</span><span class="s2">&#39; )&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                    <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                    <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
                    <span class="n">sta</span><span class="o">=</span><span class="n">station</span><span class="p">,</span>
                    <span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">)</span>

            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">&quot;stations&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;psdStats&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">key_</span> <span class="o">!=</span> <span class="s2">&quot;snclq&quot;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">key_</span><span class="p">])):</span>
                                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">key_</span><span class="p">][</span><span class="n">j</span><span class="p">])):</span>
                                    <span class="n">value</span><span class="p">[</span><span class="n">key_</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">key_</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">key_</span><span class="p">])):</span>
                                <span class="n">value</span><span class="p">[</span><span class="n">key_</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">key_</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>

                    <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                              <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                              <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                              <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="c1"># update metric values</span>

                <span class="k">if</span> <span class="s2">&quot;stations&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;noise_freq_matrix&quot;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                              <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                              <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                              <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>

                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="c1"># update session, not found in results dict</span>
            <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET session = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                          <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span>
                                                                                          <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="c1"># update created, must be last</span>
            <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET created = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                          <span class="n">val</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                                                                                          <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_insert_psdPlots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal function which inserts psdPlots into database</span>

<span class="sd">        :param conn: database conncetion</span>
<span class="sd">        :param metric: metric data</span>
<span class="sd">        :param timestamp: timestamp to be used as primary key</span>
<span class="sd">        :param overwrite: overwrite term</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">mn</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>
        <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>
        <span class="n">network</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;network&quot;</span><span class="p">]</span>
        <span class="n">station</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;channel&quot;</span><span class="p">]</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;insert into </span><span class="si">{mn}</span><span class="s2"> ( created, network, station, location, session ) values ( &#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{n}</span><span class="s2">&#39;,&#39;</span><span class="si">{sta}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;,&#39;</span><span class="si">{sn}</span><span class="s2">&#39; )&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
                <span class="n">sta</span><span class="o">=</span><span class="n">station</span><span class="p">,</span>
                <span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">)</span>

            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                              <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                              <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                              <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="c1"># update metric values</span>

                <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                              <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                              <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                              <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>

                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="c1"># update session, not found in results dict</span>
            <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET session = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                          <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span>
                                                                                          <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="c1"># update created, must be last</span>
            <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET created = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                          <span class="n">val</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                                                                                          <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_insert_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal function which inserts calibration metric into database</span>

<span class="sd">        :param conn: database conncetion</span>
<span class="sd">        :param metric: calibration metric metric data</span>
<span class="sd">        :param timestamp: timestamp to be used as primary key</span>
<span class="sd">        :param overwrite: overwrite term</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">mn</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span>
            <span class="n">snclq</span> <span class="o">=</span> <span class="n">metric</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;snclq&quot;</span><span class="p">]</span>

            <span class="n">network</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">parse_snclq</span><span class="p">(</span><span class="n">snclq</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

            <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;insert into </span><span class="si">{mn}</span><span class="s2"> ( created, network, station, channel, location, session ) values ( &#39;</span><span class="si">{c}</span><span class="s2">&#39;, &#39;</span><span class="si">{n}</span><span class="s2">&#39;,</span>
<span class="s2">                 &#39;</span><span class="si">{s}</span><span class="s2">&#39;, &#39;</span><span class="si">{chan}</span><span class="s2">&#39;, &#39;</span><span class="si">{l}</span><span class="s2">&#39;, &#39;</span><span class="si">{sn}</span><span class="s2">&#39; )&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">network</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">chan</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
                                                            <span class="n">l</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;snclq&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                                      <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                                      <span class="n">c</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="c1"># overwrite entry</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metric</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="c1"># update metric values</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;snclq&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET &#39;</span><span class="si">{key}</span><span class="s2">&#39; = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                                      <span class="n">val</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                                                                      <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

                <span class="c1"># update session, not found in results dict</span>
                <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET session = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                                                              <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session_name</span><span class="p">,</span>
                                                                                              <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

                <span class="c1"># update created, must be last</span>
                <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE </span><span class="si">{mn}</span><span class="s2"> SET created = &#39;</span><span class="si">{val}</span><span class="s2">&#39; where created = &#39;</span><span class="si">{c}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mn</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                                                                                              <span class="n">c</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_dump_database_to_spreadsheets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal function which converts db into csv files</span>

<span class="sd">        :param db_name: database name</span>
<span class="sd">        :param filepath: location to save files</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>
        <span class="n">shortname</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">shortname</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">shortname</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_tables</span><span class="p">(</span><span class="n">cursor</span><span class="p">):</span>
            <span class="n">sheetfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.csv&#39;</span> <span class="o">%</span> <span class="n">table</span>
            <span class="n">sheetpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shortname</span><span class="p">,</span> <span class="n">sheetfile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dump_table_to_spreadsheet</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">sheetpath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_list_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal function used to list tables in database</span>

<span class="sd">        :param cursor: database connection</span>
<span class="sd">        :return: list of tables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select name from sqlite_master&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cursor</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;sqlite&#39;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;idx&#39;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_dump_table_to_spreadsheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">sheetpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal function to dump data from tables into spreadsheet</span>

<span class="sd">        :param cursor: database connection</span>
<span class="sd">        :param tablename: name of table</span>
<span class="sd">        :param sheetpath: path to save csv</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">UnicodeWriter</span><span class="p">(</span><span class="n">file</span><span class="p">(</span><span class="n">sheetpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select * from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">])</span>
        <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">))</span></div>


<span class="k">class</span> <span class="nc">UnicodeWriter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A CSV writer which will write rows to CSV file &quot;f&quot;,</span>
<span class="sd">    which is encoded in the given encoding.</span>
<span class="sd">    Source: http://docs.python.org/library/csv.html#csv-examples</span>
<span class="sd">    Modified to cope with non-string columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">excel</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">cStringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getincrementalencoder</span><span class="p">(</span><span class="n">encoding</span><span class="p">)()</span>

    <span class="k">def</span> <span class="nf">encodeone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="n">unicode</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">item</span>

    <span class="k">def</span> <span class="nf">writerow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">encodeone</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">row</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">writerows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Jessica Bobeck, Katherine Anderson Aur.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.9.<br/>
    </p>
  </div>
</footer>
  </body>
</html>